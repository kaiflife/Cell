<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta
    name="viewport"
    content="width=device-width, initial-scale=1.0"
  >
  <meta
    name="description"
    content=""
  >
  <title>Constructor</title>
  <style>
    body {
      margin: 0;
      padding: 0;
    }

    header {
      height: 32px;
    }

    footer {
      display: none;
    }

    main {
      height: calc(100vh - 32px);
      width: 100vw;
      display: grid;
    }

    .cell {
      flex: 1;
      border: 1px solid black;
    }

    .cell.selected {
      border-color: red;
    }

    .level {
      width: 32px;
    }
  </style>
</head>

<body>
  <header>
    <input
      onchange="changeMenu(this)"
      list="menuList"
      id="menuInput"
    >
    <datalist id="menuList">
      <option value="verticalSlice">
      <option value="horizontalSlice">
      <option value="undo">
      <option value="redo">
      <option value="unselectAll">
    </datalist>
    <input
      class="level"
      type="number"
      id="level"
      value="1"
    />
  </header>
  <main
    id="main"
    style="grid-template-areas: 'c1'"
  >
    <div
      class="cell"
      data-cell-length="1"
      style="grid-area: c1;"
    ></div>
  </main>
  <footer></footer>

  <script>
    const main = document.getElementById('main');
    const level = document.getElementById('level');

    function toggleMainClick(enable) {
      const action = enable ? 'addEventListener' : 'removeEventListener';
      main[action]('click', selectCell);
    }

    function getLevel() {
      return +level.value;
    }

    function getElementCellLength(element) {
      return +element.dataset['cellLength']
    }

    function getMainCells() {
      return Array.from(main.children);
    }

    function doubleSubstring(str, substring) {
      const regex = new RegExp(`(${substring})(?!\\d)`, 'g');
      return str.replace(regex, '$1 $1');
    }

    function replaceSubstring(str, substring, count) {
      const currentSubStringRegex = new RegExp(`(${substring})(?!\\d)`, 'g');
      const multiplySpacesRegex = /\s{2,}/g;

      const slicedString = str
        .replaceAll(currentSubStringRegex, ' ')
        .replaceAll(multiplySpacesRegex, ` ${substring} `)
        .replaceAll('  ', ' ')
        .trim()

      const newString = rangeArray({ from: 1, to: count }).map((_, index) => substring).join(' ');

      return slicedString.replaceAll(currentSubStringRegex, newString);
    }

    toggleMainClick(true);

    function selectCell(event) {
      const cell = event.target;
      if (!cell.classList.contains('cell')) return;
      cell.classList.toggle('selected');
    }

    function createCells({ direction, selectedCell, place = 'after' }) {
      const selectedId = getCellId(selectedCell).idString;
      const rows = getRows();
      let [startIdx, endIdx] = [null, 0];
      let isStarted = false;

      rows.some(cellIds => {
        return cellIds.some((cellId, cellIndex) => {
          if (compare(cellId, selectedId)) {
            if (startIdx === null) startIdx = cellIndex;
            isStarted = true;
            endIdx = cellIndex;
          }
          return isStarted && !compare(cellId, selectedId);
        });
      });

      const currentSelectedCellRange = rangeArray({ from: startIdx, to: endIdx });
      const newIdLength = currentSelectedCellRange.length;

      const fragment = document.createDocumentFragment();
      const newIds = getNewIds(getMainCells().map(cellEl => getCellId(cellEl).idNumber));

      newIds.forEach(id => {
        fragment.append(createEl({
          className: 'cell',
          datasets: [{ value: newIdLength, name: 'cellLength' }],
          style: { 'grid-area': id }
        }));
      });

      let newRows = rows.reduce((prevString, cellIds, rowIndex) => {
        cellIds.forEach((cellId, cellIndex) => {
          const isFirstCell = cellIndex === 0;
          const oldString = `${isFirstCell ? '' : ' '}${cellId}`;

          if (isFirstCell) prevString += rowIndex ? ' ' : '"';

          const addNewIds = ({ place }) => {
            newIds.forEach(newId => {
              currentSelectedCellRange.forEach(() => prevString += `${place === 'after' ? ' ' : ''}${newId}`)
            });
          };

          if (direction === 'verticalSlice') {
            if (place === 'before' && compare(cellId, selectedId) && compare(startIdx, cellIndex)) {
              addNewIds({ place });
              prevString += oldString;
            } else if (place === 'after' && compare(cellId, selectedId) && compare(endIdx, cellIndex)) {
              prevString += oldString;
              addNewIds({ place });
            } else {
              prevString += oldString;
            }
          }

          if (cellIndex === cellIds.length - 1) prevString += '"';
        });
        return prevString;
      }, '');

      getMainCells().forEach(element => {
        const elId = getCellId(element).idString;
        if (!compare(elId, selectedId)) {
          const singleSelectedCellCount = 1;
          const newCellLength = (getLevel() + singleSelectedCellCount) * getElementCellLength(element);

          element.dataset['cellLength'] = newCellLength;

          newRows = replaceSubstring(newRows, elId, newCellLength);
        }
      });

      setMainRows({ newRows });
      selectedCell[place](fragment);
    }

    function getCellId(cellEl) {
      const idString = cellEl.style['grid-area'];
      return { idString, idNumber: Number(idString.slice(1)) };
    }

    function getMainRows() {
      const gridTemplateAreas = main.style['grid-template-areas'];
      return gridTemplateAreas.replaceAll('" ', '"columnSpace').replaceAll('"', '').split("columnSpace");
    }

    function setMainRows({ newRows }) {
      main.style['grid-template-areas'] = newRows;
    }

    function getRows() {
      return getMainRows().map(row => row.replaceAll('"', '').split(' '));
    }
    
    function getColumns() {
      const rows = getRows();

      return rows.map((cellIds, rowIndex) => cellIds.map((cellId, cellIndex) => rows[cellIndex][rowIndex]));
    }

    function getNewIds(items) {
      const newMax = Math.max(...items) + 1;
      const sliceCount = getLevel() - 1;
      return rangeArray({ from: newMax, to: newMax + sliceCount, before: 'c' });
    }

    function changeMenu(menuEl) {
      const { value } = menuEl;
      const selectedCells = getSelectedCells();

      if (value === 'verticalSlice' || value === 'horizontalSlice') {
        selectedCells.forEach(selectedCell => createCells({ direction: value, selectedCell }));
      } else if (value === 'unselectAll') {
        selectedCells.forEach(selectedCell => selectedCell.classList.toggle('selected'));
      }

      menuEl.value = '';
    }

    function getSelectedCells() {
      return Array.from(document.querySelectorAll('.selected'));
    }

    function createEl({ elName = 'div', className = '', type = '', datasets, innerHTML = '', style = {}, appendTo = '' }) {
      const el = document.createElement(elName);
      if (className) el.className = className;
      if (datasets) datasets.forEach(({ value, name }) => el.dataset[name] = value)
      if (type) el.type = type;
      if (style) Object.assign(el.style, style);
      if (innerHTML) el.innerHTML = innerHTML;
      if (appendTo) document.querySelector(appendTo).append(el);
      return el;
    }

    function rangeArray({ from = 0, to = 0, before = '', handler }) {
      const newArray = [];
      for (let index = from; index <= to; index++) {
        let value = `${before}${index}`;
        handler?.(value, index);
        newArray.push(value);
      }
      return newArray;
    }

    function compare(id1, id2) {
      return String(id1) === String(id2);
    }
  </script>
</body>

</html>